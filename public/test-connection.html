<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Connection Test - Plug HR</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .test-result {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .success {
      border-color: #10b981;
      background: #064e3b;
    }
    .error {
      border-color: #ef4444;
      background: #7f1d1d;
    }
    pre {
      background: #0f172a;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      border: 1px solid #334155;
    }
    .spinner {
      border: 3px solid #334155;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    h1 {
      color: #3b82f6;
    }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      margin-left: 10px;
    }
    .status.ok { background: #10b981; color: white; }
    .status.fail { background: #ef4444; color: white; }
    .info { color: #94a3b8; font-size: 14px; }
  </style>
</head>
<body>
  <h1>üîç Supabase Connection Test</h1>
  <p class="info">Testing Firebase Hosting ‚Üí Supabase integration</p>
  
  <div id="loading">
    <div class="spinner"></div>
    <p style="text-align: center;">Running tests...</p>
  </div>
  
  <div id="results" style="display: none;"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const SUPABASE_URL = 'https://edkbavihyscadffdbzod.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVka2JhdmloeXNjYWRmZmRiem9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTc3MzMsImV4cCI6MjA4Mzk3MzczM30.c8njFAuqYrh9U6T04_bPtejIelJ0rJkiQrJfJLInVi0'
    
    const results = document.getElementById('results')
    const loading = document.getElementById('loading')
    
    async function runTests() {
      const testResults = []
      
      // Test 1: Environment Variables
      testResults.push({
        name: 'Environment Variables',
        success: SUPABASE_URL && SUPABASE_ANON_KEY,
        data: {
          url: SUPABASE_URL ? '‚úì Set' : '‚úó Missing',
          key: SUPABASE_ANON_KEY ? '‚úì Set' : '‚úó Missing'
        }
      })
      
      // Test 2: Client Creation
      let supabase
      try {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        testResults.push({
          name: 'Supabase Client Creation',
          success: true,
          data: { status: 'Client initialized successfully' }
        })
      } catch (error) {
        testResults.push({
          name: 'Supabase Client Creation',
          success: false,
          error: error.message
        })
        displayResults(testResults)
        return
      }
      
      // Test 3: Network Connection
      try {
        const { data, error } = await supabase
          .from('employees')
          .select('count')
          .limit(1)
        
        if (error) {
          // Check if it's an auth error (expected) or connection error
          if (error.code === 'PGRST301' || error.message.includes('JWT')) {
            testResults.push({
              name: 'Network Connection',
              success: true,
              data: { 
                status: 'Connection works',
                note: 'Auth required (expected for protected tables)'
              }
            })
          } else {
            testResults.push({
              name: 'Network Connection',
              success: false,
              error: error.message,
              code: error.code
            })
          }
        } else {
          testResults.push({
            name: 'Network Connection',
            success: true,
            data: { status: 'Connected', count: data?.length || 0 }
          })
        }
      } catch (error) {
        testResults.push({
          name: 'Network Connection',
          success: false,
          error: error.message
        })
      }
      
      // Test 4: CORS Check
      try {
        const response = await fetch(SUPABASE_URL + '/rest/v1/', {
          headers: {
            'apikey': SUPABASE_ANON_KEY
          }
        })
        
        testResults.push({
          name: 'CORS Configuration',
          success: response.ok || response.status === 404,
          data: { 
            status: response.status,
            origin: window.location.origin
          }
        })
      } catch (error) {
        if (error.message.includes('CORS')) {
          testResults.push({
            name: 'CORS Configuration',
            success: false,
            error: 'CORS blocked - need to add domain to Supabase',
            fix: `Add ${window.location.origin} to Supabase Dashboard ‚Üí Authentication ‚Üí URL Configuration`
          })
        } else {
          testResults.push({
            name: 'CORS Configuration',
            success: false,
            error: error.message
          })
        }
      }
      
      displayResults(testResults)
    }
    
    function displayResults(testResults) {
      loading.style.display = 'none'
      results.style.display = 'block'
      
      const allSuccess = testResults.every(t => t.success)
      
      results.innerHTML = `
        <h2>Test Results ${allSuccess ? '‚úÖ' : '‚ö†Ô∏è'}</h2>
        ${testResults.map(result => `
          <div class="test-result ${result.success ? 'success' : 'error'}">
            <h3>
              ${result.success ? '‚úÖ' : '‚ùå'} ${result.name}
              <span class="status ${result.success ? 'ok' : 'fail'}">
                ${result.success ? 'PASS' : 'FAIL'}
              </span>
            </h3>
            ${result.data ? `<pre>${JSON.stringify(result.data, null, 2)}</pre>` : ''}
            ${result.error ? `<pre style="color: #fca5a5;">Error: ${result.error}</pre>` : ''}
            ${result.fix ? `<pre style="color: #fde047;">Fix: ${result.fix}</pre>` : ''}
          </div>
        `).join('')}
        
        <div class="test-result" style="background: #1e293b; margin-top: 30px;">
          <h3>Summary</h3>
          <p>
            <strong>Total Tests:</strong> ${testResults.length}<br>
            <strong>Passed:</strong> ${testResults.filter(t => t.success).length}<br>
            <strong>Failed:</strong> ${testResults.filter(t => !t.success).length}
          </p>
          <p class="info">
            Current URL: ${window.location.origin}<br>
            Supabase URL: ${SUPABASE_URL}
          </p>
        </div>
        
        ${!allSuccess ? `
          <div class="test-result error">
            <h3>üîß Action Required</h3>
            <ol>
              <li>Go to <a href="https://supabase.com/dashboard/project/edkbavihyscadffdbzod/settings/api" target="_blank" style="color: #60a5fa;">Supabase Dashboard</a></li>
              <li>Navigate to: <strong>Authentication ‚Üí URL Configuration</strong></li>
              <li>Add site URL: <code>${window.location.origin}</code></li>
              <li>Add redirect URL: <code>${window.location.origin}/**</code></li>
              <li>Save and test again</li>
            </ol>
          </div>
        ` : ''}
      `
    }
    
    // Run tests on load
    runTests()
  </script>
</body>
</html>
